"""Dedicated adapter for DataManager GWAS scraper outputs."""

from __future__ import annotations

from pathlib import Path
from typing import Any, Iterable

import pandas as pd

from datahub.adapters.base import DataAdapter
from datahub.adapters.common import TabularAdapterMixin, expand_input_paths
from datahub.adapters.phenotypes import PhenotypeMapper
from datahub.models import CanonicalRecord


class GWASAssociationAdapter(DataAdapter, TabularAdapterMixin):
    """Ingest GWAS tabular outputs into canonical association records.

    Supported inputs include files generated by:
    ``analyzer/DataManager/src/scrapers/GWAS/files/gwas_results_*.csv``
    and related tables with equivalent columns.
    """

    name = "gwas_association"

    def __init__(
        self,
        *,
        input_paths: str | Path | Iterable[str | Path],
        dataset_id: str = "hbp_gwas_association",
        source: str = "gwas_catalog",
        phenotype_mapper: PhenotypeMapper | None = None,
        include_dataset_types: set[str] | None = None,
        chunksize: int = 100_000,
    ) -> None:
        self.input_paths = expand_input_paths(input_paths)
        self.dataset_id = dataset_id
        self.source = source
        self.phenotype_mapper = phenotype_mapper or PhenotypeMapper(mapping={})
        self.include_dataset_types = (
            {item.upper() for item in include_dataset_types}
            if include_dataset_types
            else None
        )
        self.chunksize = chunksize

    def read(self) -> Iterable[CanonicalRecord]:
        usecols = {
            "MarkerID",
            "rsId",
            "gene",
            "gene_name",
            "gene_id",
            "Phenotype",
            "phenotype",
            "pval",
            "p_value",
            "PMID",
            "Study",
            "StudyGenomeBuild",
            "functional_class",
            "var_class",
            "most_severe_consequence",
            "clinical_significance",
        }

        for input_path in self.input_paths:
            frame_iter = pd.read_csv(
                input_path,
                usecols=lambda col: col in usecols,
                chunksize=self.chunksize,
            )

            for frame in frame_iter:
                for row in frame.to_dict(orient="records"):
                    record = self._to_record(row, input_path)
                    if record is not None:
                        yield record

    def _to_record(self, row: dict[str, Any], source_path: Path) -> CanonicalRecord | None:
        gene_id = self._pick_gene(row)
        variant_id = self._pick_variant_id(row)
        phenotype = self._normalize_phenotype(row.get("Phenotype") or row.get("phenotype"))

        if not gene_id or not variant_id or not phenotype:
            return None

        dataset_type, category = self.phenotype_mapper.resolve(phenotype)
        dataset_type = dataset_type.upper()
        if dataset_type not in {"CVD", "TRAIT"}:
            dataset_type = "CVD"

        if not self._should_include_dataset_type(dataset_type, self.include_dataset_types):
            return None

        return CanonicalRecord(
            dataset_id=self.dataset_id,
            dataset_type=dataset_type,
            source=self.source,
            gene_id=gene_id,
            variant_id=variant_id,
            phenotype=phenotype,
            disease_category=category,
            variation_type=self._to_string(row.get("var_class")),
            clinical_significance=self._to_string(row.get("clinical_significance")),
            most_severe_consequence=self._to_string(row.get("most_severe_consequence")),
            p_value=self._to_float(row.get("pval") or row.get("p_value")),
            pmid=self._to_string(row.get("PMID")),
            ancestry={},
            metadata={
                "study": self._to_string(row.get("Study")),
                "study_genome_build": self._to_string(row.get("StudyGenomeBuild")),
                "functional_class": self._to_string(row.get("functional_class")),
                "source_file": str(source_path),
            },
        )

    def _pick_gene(self, row: dict[str, Any]) -> str | None:
        return (
            self._to_string(row.get("gene"))
            or self._to_string(row.get("gene_name"))
            or self._to_string(row.get("gene_id"))
        )

    def _pick_variant_id(self, row: dict[str, Any]) -> str | None:
        rsid = self._to_string(row.get("rsId"))
        if rsid:
            return rsid

        marker = self._to_string(row.get("MarkerID"))
        if marker is None:
            return None

        return marker.split("-")[0]
